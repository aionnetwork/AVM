package org.aion.avm.core.miscvisitors.interfaceVisitor;

import org.aion.avm.core.*;
import org.aion.avm.core.blockchainruntime.EmptyCapabilities;
import org.aion.avm.core.dappreading.JarBuilder;
import org.aion.avm.core.miscvisitors.interfaceVisitor.interfaces.*;
import org.aion.avm.core.util.Helpers;
import org.aion.avm.userlib.CodeAndArguments;
import org.aion.avm.userlib.abi.ABIDecoder;
import org.aion.avm.userlib.abi.ABIEncoder;
import org.aion.avm.userlib.abi.ABIException;
import org.aion.avm.userlib.abi.ABIStreamingEncoder;
import org.aion.kernel.TestingBlock;
import org.aion.kernel.TestingState;
import org.aion.types.AionAddress;
import org.aion.types.Transaction;
import org.aion.types.TransactionResult;
import org.junit.AfterClass;
import org.junit.Assert;
import org.junit.BeforeClass;
import org.junit.Test;

import java.math.BigInteger;
import java.util.HashMap;
import java.util.Map;

import static org.aion.avm.core.miscvisitors.interfaceVisitor.InterfaceFieldClassGeneratorTest.*;
import static org.junit.Assert.assertTrue;

public class InterfaceFieldIntegrationTest {
    private static AionAddress deployer = TestingState.PREMINED_ADDRESS;
    private static AvmImpl avm;
    private static TestingState kernel;

    @BeforeClass
    public static void setupClass() {
        TestingBlock block = new TestingBlock(new byte[32], 1, Helpers.randomAddress(), System.currentTimeMillis(), new byte[0]);
        kernel = new TestingState(block);
        avm = CommonAvmFactory.buildAvmInstanceForConfiguration(new EmptyCapabilities(), new AvmConfiguration());
    }

    @AfterClass
    public static void tearDown() {
        avm.shutdown();
    }

    @Test
    public void FIELDSClassDefinedFail() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(FieldsClassDefinedInterfaceFail.class, FIELDSInterfaceFail.class, ABIEncoder.class, ABIDecoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        // values below are retrieved from the old version of the AVM (with InterfaceFieldMappingVisitor) after deployment
        String transformedCode = "504b0304140008080800dd86434f000000000000000000000000140015004d4554412d494e462f4d414e49464553542e4d4655540d00072260965d2260965d2260965dfeca0000358b3b0a84301086fb40ee900b38acadad8bb085adfd1027cb0f710233c1f3afacd87e8f951545bc0f9b98a3e994467ac5b03274982bbb4fa9d997f852c4e741b999d001cf271cbd9913b48b15ceb2dd841648ddfd3fbf634852a0b27f9e6a61d41862f801504b0708c01f64db6500000079000000504b0304140008080800dd86434f0000000000000000000000002d001100752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c61737355540d00072260965d2260965d2260965d4d90cb4e02311486ff028a0e831704f1821aef032e1a13e34663a2482204371a676b8a34630d76cc500c3e962b880b1fc087329e3a18e9a2a73dfdce7ffed3afef8f4f00c7f018f67b3c8c022e54a8b9787de6bdae8c3aaac5454bf1f38b7aadff205f0c3da6c1184a5dfe245e05ef081df09b9e36ea598e1149863c69dc9384121d5f465d4adfd52f19586302f12295c953a5953963287acd71c15b13291d9c94fd2471292aba4ac365c8486d64742dcd63d8664879f5b2ef6206b30eb298fb933d62701f1e4514c89a9651f066c18605f3285870d1c5341c07292c3138b2af4c2ce86225565a65487a71ebc49fe8a12d5ab3459b3499d7fcb7ea87aa7df26b641adb16d861c85643dd35421b5f747a920c54c3b69cda44829e696e3898c024c53ddb02f45b74264fb4ef53668b72098a8bb9cc10f379e48628560e0658b6f7d27bfc77d6ce88b7ba8c6221b7fecb6f587e802d7b1dc3b747f802b5b3b3a52b07a5017663003f504b07083ee22bfb6701000009020000504b0304140008080800dd86434f00000000000000000000000007001100432e636c61737355540d00072260965d2260965d2260965d45d2494e5b411845e1ff11c0367d42dfb749e86d57f36cfac60c9118b000645084829091c062710c58008b4258e8a86e4dbe3b28d599d4c7e7dbbb99e5769159d6285896d9c843f3b5597e6cb6eecb57b70fffeeda05fb9159e1eea9f5d2bea9643676f952d695ebf6f3ffd6fd41ba504dcba5e5d30a69c5b4f2b46a69d5d3dacbacc8cb15cdaaa6d3f49a41336ae69a35cdbaa66a4e35a79a53cda9e65473aa39d59c6a4e35a79a57cdabe655f3aa79d5bc6a5e35af9a57cdab16540baa05d5826a41b5a05a502da816540baa45d5a26a51b5a85a542daa16558baa45d5a26ab96a79b5b86c5dd6ddf9dfc756b21eebedac9215b08825ecc37e1cc0411cc2611cc19ff80b47710cc7710227710aa7710667710ee7710117710997710557710d7fe31ffc8bebb8819bb885dbb883bb58c60a56d1a1c7801173ac611df7701f0ff0108ff0184ff014cff01c1bdf76ce17504b0708eb568b3b50010000dc040000504b0304140008080800dd86434f0000000000000000000000005d001100752f6f72672f61696f6e2f61766d2f636f72652f6d69736376697369746f72732f696e7465726661636556697369746f722f696e74657266616365732f4649454c4453496e746572666163654661696c244649454c44532e636c61737355540d00072260965d2260965d2260965d4d8ecd6a02411084abfd5bff72507c040f9a4b835725971841103c08eb51c675b2b4e80ccc8cfb5e39053ce401f250c15109da97eafaa8a6faf7effc03608436617d62eb7256620dabe2c899759a8fe2b342bc04eb3c8b09da7daa4ca777f2009e67f38fc57435ff07332587fe9d252042d7f35e158a0fcae4bcdcee75161294092fb169634ff16ae38323f416cfc1557062f231a1361123e18d501e0cd33612d49ba8a041a8bcdb9d8ecf97a205080d5451bb6da56b2a6a2bba4e548a5a7dfd46f30bb7b900504b07086af8b7e2c6000000fb000000504b0304140008080800dd86434f00000000000000000000000056001100752f6f72672f61696f6e2f61766d2f636f72652f6d69736376697369746f72732f696e7465726661636556697369746f722f696e74657266616365732f4649454c4453496e746572666163654661696c2e636c61737355540d00072260965d2260965d2260965dadcd4d0ac2301005e037fec556110fe17e765e402d04040541d731c492d22690d41ece8507f05062a5142fe02c66de7cb398d7fbf104b0c68c70bcb30f392beb1daba662ed83e1ca46ddd8686b1f225b579b7053da9c3bf941e44ceef6db93ec2153b61420c2b2508de252b99c0fd7c2e85a6048482ccb7e1d132eff7ebdea4c4010265d26cca573266c4a15a3890bc20023b4677c8b90b63d6de7b4f504c907504b0708e299a8f8a00000001a010000504b0304140008080800dd86434f0000000000000000000000002b001100752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f414249456e636f6465722e636c61737355540d00072260965d2260965d2260965dad5a6b745c5515fe4ee6712793693b99dc3c9a4ed24e52421e1386a69256425bf268e884a455d255a108cd341992403a132653da823cd42ae812b02e447928581e4141a02c68a7b078092a02bac4f7021471a928ba7c2dabb2808efbdc7beecc7d4c9abb32f063e69e3de77c7b7fdfd967df7d1a5e3cfef853003ad9168693764792a9f1486c329988c42edb15d93d134f4d4dee8cc4764e46ba7ba21b13a3c9b1784a026308cc442e8e5d168b4cc512e3912d3b2f8e8fa625381816d1ba1d3de76dddb863a87bf86c061675107a96c17dc6646232bd9ec1d1dcb28ddb4ae8c74d12ca18cae289743c35144f4f24c7189ccdd1966d3e2cc2622f7c58e282fadf2a06dfe8442c351edf9888a7c6f7f189037c6205643eb1d2070f4abd70a29ac11bdf3b9956017d58aa22d53294f3e0e20a8b2d8978cfbe749cc1dfdcd332188bf041772a15dbd7c56373695e93149dee47092186524e4419f2d551e36a1f1ab1d28b069c444c67e269065773b487c779329ab9bd85413686914c4ec563098eb5dd88a50531aa3d2cd51e1cdac34a862a035a2f49141b2539395eaf95995b5b7933eda161e5f0443295e6ab868dabccf14669b3c6e3290de7676659079389710e3360755e2a16b1116d75d61c45ff5432a644d16f5d2e69abfe493ef5f9a72c9270b600bb880fb72629d09ec9f40c4f94fe96a80f43d8ecc52028cf2b0c2efb92bb774e2999d067f559a6857ca529e7d55512b6097dc694f1d624a7afb9ed6b19f0e15c9ce7c5c7b0ddbc53393f0cc16683dfc25950a73d5ca23d2c67f0c4225191997474dc53f1c4787a42396344f8228c97218e096dfe8d0c27cf73c2f78ec6a7d3f4a384293a9ebd12282fa5d1646226bd830ea03ca85760389d9a4c8c53c64fe3d25224412957dd5c6806cf7e0fd25eecc26e86257b52b1e9ee99ad13a9e49e98227c9b71955a4d4885bc293799bcedc15e7e9cf769ac0e9b366678df4c3abe4bc295a218c5b83ca3c96955e7c94854e047f5cf4ac9b91ad77871153ea92153c5585ae8a88a5d5baeec9aced4654d1f8f8675abf6d0cab0d8b84cc21768c7c679ade0b56fbb0f37e0462faec717b5354d0ccb0a9f727d0271e38912e8a0f630ad14b5dc7409b7aa9e7bb9e7dbbdb80d5fa3adb41607e1ac8e3bcb1bbacce5c2a7ff55c23754f0610e7e97170771b75956515104fc320e4fa61351f93195f8fc2409df527d44b98f07bcb81fdf369f367e2cf562e5c60536cdab9df93b15a17253253caafa19e07e0e7bf1188e9885524a915ea8bc610e2e2f2b8ae5a7497852f5d2cfbd3cedc5537886a1a640c9126eeab91b9da500239fc6689a1f0afd6409df57bdf5716f3ff0e205bc682e90ea3166682c7cba0bb27ac37c2a95c912df391f07a774e78ba84c2e6936bf417f829f7af10a7fb318df3cdd6363a9f8cc8cc2785a295fc232470c9b88ac619e8457c91fc74c2773d37d789dfb7b0dbfce95ba537d7843ad69bfd5b0a6cc1bdd33392ef296aa6a4e985db1f44424ff93e56c54159e27e18f5ebca58ba0c3873fab11bcad4570c09c041d7dba5748154f82952b7be690e213da43373524ca4409ffa643a4b62f7c1d6f5cfee3c531fc579b4a957971ae448a647997a192afb1546b9e3def97e13d1cf7e1e3b8c0abb4771455d43a55698658094d66b93ea69170d557772c9d8e273afa945e53c9ba1a8d59d4d4a8f998c43cdc51a9b93c9232864a2dc4d96ed90e458aed125be4c367f0598eb5848ead09cb5c6c055a6f61b45e8955f87013beccd12acda5aea34f5f4905d27061a461892df5e10edcc9919659391acba6c08a16c68a4a6cb90ff762966385ac51e9cb9640ea2f8cd42fb1937c388ac739d2c9d69cd4155a013450186840626d3e3c848739503b43ad09c850e304545f61a83e89adf2e13b788e43ad36c7a4961e014447754f64c7fc758c5c169e27b1353ebc8c1f72571f360b29ea8cf0d5a0fa3a51a9a246d6324562eb7cf8057ec93d6ca0d7d51c6547386933109aaffed4ce3d5762f4feff3dfec0dd6ed4ce25350272b3ee086f4b4e8e7529cd928745e9b2c506a8c6f6f292154ba4b7c5a67653d170f652a8641e4ec7462f198a4d6fe58d9b67154ae86e46af2078e1829bee9083342a015da9e893ae6e6419220b1f31faae0c7833f0cb28cfa0aaf5086af870d92125a852045127a647e0a005544002f5caf4e534dd9541d3609bc37918ad6dce5afec97f5cf6b058dc86b0587c2945c217af178bdbf38b5deae25bb0484684ccce597865aca227878cd5f475c080cbd86635f62c9a483f892e7a25f4c1b2c4541d3af8902e8f380d9dc27d0f09c2dd7706d628eed712ac5b75ef56ddfb3d9797237b95e2cb559b7be4f373744e47d7fc78927dbc33b052e05d28f0ce1178eb08cfa3e279045e8d1ecfefcf8fdc065fd21cbe36e04ce1eb2e128a772a5f09742bbe7ac897bf949c0d851d7eae46d859ef5f7b858cbeabafe3386157bdff54ddd05def6fd60da57aff0addd053efafd10dfd34dbaf1fd3748f7eeca9cf0f7840b980fb719608788cc4e1019f1bd8a4041cd5c469c8e023ebda1c7e55f2a041a2a041a2a041a2605ea24d3a8f1fc539c2e37d24113f97b70786158f5b73123565707e0fe9e451740a19750a19750a19750a19750a99740a99740a99740ae9741ad6454d2d8088fa2571c61e123a5d4851b3d67bb15cc648feb8f93b14b5fce5f4358b7d3276f2637f14935420afcede8da08c8bc9f204769df708668ee03245a30c2e7f5ac615b9a9ae11e788c02b57f054b321eb05a818b73adadcaa25834fc9f83441e5e5570fb5178e70eb7b18e087b894b7092a31d641c478417b3b70ad0d620185d8a336885d9b23765d2162017bc41cebdceb556741f587835823e3f39c5f5d6bf0300e14ae6c5f12956d7f09dbef60b3d9a7354dae3568d20977b8f538ba959a96450b9c12ae570b5caeece54d6ae97b0701d28f1a23a15f19a9675fbf8a05e877735ebf099d82150b56f034195fcd29f875fdda3ae78862d30c8a7e25b3d9670bebb7044eae5faf10a69b84a13e6f41c2c81f9c30f20723cc3d0584b967e1c250d32a8459ad0ac302b684a95484797d81c2487a612a172ccc0532eecb09f3a0fe5d20847950ff46a873099b5e40b76a3308e89ccdde624bc04912905a6c21e00dfc58d2f7aec0211b02567101d91a1b021e2a20a0dfa357b06ac10a1e91f1484ec18cfed5a64998d1bfe0340d33fad79c266246ffb26bab9384b1466ff408a35f6ff46beb3d06ab00c89994bdf1cc6637687b73a8d0def489bd798ef686ee51626f56d1ced0db9df9450374e2bda95692fb551b7bd33d5f72572f786bce97f104c7240d9ea5a6a7d3d95657e934e538198c094e066376573acda97d9b265ff789527b9ce4a32b9f90ef1a4a6d377def083c6f43be1a25b55b6cc8f7fcbca95db360fdbe29e3bb42bf97a8835b43fa5539cd194e16537a93c594db64312536594c594d16734a93c99ccf554e4b320f69bbf1fc8992f931da0dba158ba6ef6e4a65de1c7fce56a50e29c93c2ce3475c8dc3f8f950d8dcf584949961abc86183c8616ae7c2e676ce58204b51127e0f5bd46e8e6ed922e24322e2eb6c45dca0447c8e8c5fa911ff66c8bf42f57b873187de34be5f7ec75bf690c06a500376ce137035f59fefe314ba283764b19cf757aff1e03913baad8bf09f14cde84db6aa47a312fe85b9f0ff2404f7af301d81bf182bc85fe90775e67acaccdce6342aa87562035c753a2add735369e354ded2a8fc0d7f1754de540b211e30516992f18ffc8556a3b24ac902716f48caf8174d91d6692dfdff363b3a9deaa9ab746ac7ae4bc63b6468274ba5f328b22578060d19c6e8f328733a106ccf9b952523ebf63ba9177e5c662ebe2ee82fcf30ef60618a8d70aece42864bc231d0c5ff1803dec5a62c1671bac7045d56c67cc5d00d1449f7fa0cf3dba71bb043972db6d0658b35bae52c500cdd8a22e9de966155f6e956d8a22b5be9ca1add6a56530c5db948ba07332c689fae6c8b6ead956ead46b78ed51743b7b248baf76758837dba95b6e8aeb0d25da1d16d642b8ba15b5d24dda732acd93edd6a5b749bac749b34ba2dacb518ba5545d27d2cc34eb14fb7ca16ddb0956e58a31b61a71643b7a648ba2f64d887ecd3adb145b7c34ab743a37b1aeb2c866ea848baaf64d8e9f6e9866cd15d6ba5bb56a3dbc5ce28866e4391745fcbb033edd36db04577bd95ee7a8d6e37eb29866e639174dfcab07efb741b6dd1edb3d2ed53e97af9df8305ddefa9d741ccaad7417616815213dbb4b9dda1906b7706f9a7cb726d6b771baf6d52a7d3d1e912645d1ad97ef5dfbb5a2b5d1a258742dc6560487db0d538d2e9dcef22de0fa94cdb4dd72a22741cfdcaa5ea5d0c83f1bfb3094e15744151fe37b8d6b6e01176b6fab730fc1f504b0708dff0b6f8580c0000c0290000504b0304140008080800dd86434f00000000000000000000000057001100752f6f72672f61696f6e2f61766d2f636f72652f6d69736376697369746f72732f696e7465726661636556697369746f722f4669656c6473436c617373446566696e6564496e746572666163654661696c2e636c61737355540d00072260965d2260965d2260965dad54eb52d35010fe0e0503310896025e5060006d418d7841b0de801628968b82e01d4fd343395a124c02234fe033f816c20fe9e88c0fe00bf94bc73d49cb6d741c67cc8f24bbe7dbdd6fbfdde4dbcfcf5f010c40323c58371db76072e9d826df58352dc715e6aaf4ac0de949df713d53dabe7097b92516428f39264531ef8d16b9e7a5c4b2b4453e53818c7159d4c018a29ef99a6f70b3c8ed8239937b2d2c5f438461f1dfcbed3a3c732c93cea6e60e54eb0e7d1a6a1866ff77720d1ac391f0805e6e495bfa771822f1c4428404ac6260131aea198e0a153625fc1527cf501dcf24160c34a051c7311caf4178f53318d60a770b226d0bb7b0a980930ad88c16056c35a0e3a88e6a9c64d0c53be987090d9c0e33b531d4525f4bab5cda0c0df144969b239bbe18765dbe99548c6a2ab5be33f41c5263dd136e51e64c9e93e6f04826252c272f5c0d5d0c8d6b0162a4e8586f88a1b435f45053aa5641f829ee7303e7d1aee31ce2848e1fa8ab3ad0d1aba31b7d0c3115940f7287eca7f9aa606821b2fb5762ce77a55d481ab8884b2ad2242947352551ade5d89ebf747d9072fd3ee42aaed5e10aae1fdab2f05cc30d124f91106fd779d1633816cf4a3313ee6032f1d4c0106eea1844b2a2559aa1b5dc6ac6a6c9049b1d66337057f1abc2bdbfea99b6cb7a8e303405f503c78c2dc2540c5df1dff5737088065248eb18c55885dddd3d49860c4c86bddf274577299717b6c2782a643c5d4930ae26b95742c343863ab5c981a9c69939cc611e8f74cc21587256c9d34e5055532a8d96bc72b5678ad0113cafa04eedd21de837f02aa4cb6996f1ec5eeb0b8ecc2733e1e2586ae1d547334a6a31d4cff9dc7a33c5d7e679ae48b6b13712e1d5765263d5419d1a30f5b5d07d992ce567f46c8e1a254463682ae144ef0e4e29f3cc56105087b3682fc3df234201808c7604f04e827f41f79312123bb870bff7132e67fbb631f009b73ea03986db745ec27009e32ae0ccc71826c84388ec41c4cc3ec42c7922252c86b6121205ba1ba8fa811b1aba350c765207b45f65521d012520167d1c90223627b6f14259413c083df547f4cb009ddb8756fa5865741335ac86a9f5f6b5ed406c95012b4152fab3a196f4a9fb05504b0708489d1d032d03000018060000504b0304140008080800dd86434f0000000000000000000000002b001100752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f4142494465636f6465722e636c61737355540d00072260965d2260965d2260965dc55b095c5cd5b9ffbecb0c172e37c94006b200812c1896c40910b298908425344380b492970acf369990112602436130925aa36decf27c7dd61a6df5b535b5dab47d26ae01d456696b179767dbe7ebaa6d6d6cd5b6b16a175b95cafbce3de7ae330c337920fef2cbdc39cbf7ff9fffff3bcb3d191f7ffbc18701609db40ba168d017eeeff40542e15e5fe0b21edfe040b0bf3bb4df17d81ff2d5d4faeb831de103c17e1910216bc077307059c0d71de8edf4edda7f30d811912105610ef5db5bdbb67bfbdee69ad69d08e84fa1e813d68a567ffb7656988690c60a0f042201aa6f0af86a8722c19afefec0d026049555f585074211628390ba39d41b8a6c41f014db1a96ec61a15c04b443060f4246b03712ec6f0e46bac207105cc5fe923d2a64c17c0532c1eb06fe5f3385efe80af47706b7f706fb3b8758c346d670212c620d1723a414b3ef73204f0117e4aba040463a4850a0820aa9ec69298212bc3c14e1502a2ce7182b10bcdaa034ad78654ba0278890535cd26415ad35d21feaeddca4732a2235ba0387879ac2018a56ca81cbf4da954c2b9f5f1bb30c3ed2a33bd8db19e9d288fa5528878a0c5803957afb3cfda10461bec967576f90c3aab011562a348c0b1c56f26a1936eb01160b2b3a8391d6ae707f44436c65a2a7ea4d8e91ec164f64d84e8da83dd7bf568577c10e051ac04f928950fede88e88d12ebcd4b9bc2bd9d5afc46bdf2759138ac520c98c5f4ebd055fac375082be367eff6cb3b827d2c9964b888d2a54e867612b523dc3b10d95b5149b6c57247858be17de9f0aff07e8405c5b15af034d9a7401b5016cf3bd41fe8ab19d8ddd51f3e14d8df4db697d97bf1a9b2a9a4c92c321a135a071c605914d487d5aec236a86146854cb2eb55b894b3ea46c8b4b9cb4cd014acd523d0b4ce614d3aba821d97b60c76776fefe98b0cd5d39c53a19f6599040346e8f2752a0cf2d097e9019a8cdab5e52a1ce6b51fd46bfdb67c670cc2e1ee60a05723610a5c5ea5c2d5bceb878dc2ca8d2a1ce585d7e8f176e80f8bf48714fd618118890155475338d041d35d03ab33055aa3c2f53ceea78dc22a2a3cc60b6fd42392eb59f6c9c1325caf2d770e8d9236d8c9d0749cb52a7c9e87fc828943121ee7855f546127543085bfe4f48967ba2e0ee9f065dee58429f60615beca0bbfa6420bec6271ee74126ee80e07f8946c30c351cfbb79cf7bcc7044eb3e5e783f91b1a6a416438661113bd41ba90d45067687456c36df1a54188507141881079deb497d7850cb73a2506f52a0147d98a33d625220b9bec90bbfe558757810191e159277933c9c841e9e2dd0f52a7c17bea7c077e0fbce5430161f9a82b4ce5a7708dd4ef22dd79808cda15ebe9e3484fbf99454e1293e1b7ea077d8a23f549843a024fa311fc24ff4da3b54b8105a59cf5f20a4b35d4a10f1907036262a3c0bbf640be1af9c8beed04024d823c37362b50bb0e61de13e0a9257dc14f2f9c5aae1b73e6b3bdb19785e81dfc06f1116c59a8582491697c452b6892de019fa10da10e6daeb65f823192d0660edc7c6f0b20267e14f7ae77cfda1457fa0ad3165802dffee627f3b63f93afc9d75f98770207a02dbac63a526c97453fc0a15fec9c57f5bdb718c8632ade7badc666fa28a928288c60a52a751aad328a1ccaae80cb2207a05300c6401cd924d26958d2aaa1a159cc3f6474b2319e7d1fce25c2c5d19994c053d98a593a9d1c8b4723239ac6a81d345b1e0083a73353a54e6205355a5622e2793c77658a3898c4b98a67e5b3746a450c1025caae1fb39fe7256b2c239abd82a65b3c628b048b15ec5628e5ea2b962b491b1cc70c5ecc8f0572bb80acfd7f01b39fe1a5652ee34435b816c669825160634fe2ace609d6686d948c60d861996ae8cc3050a6e446371b84823d3c0c96c6555db1016c658e8049b4c8d8da5c842a752c57a4e673b9bcfd65632be8bcd46bfb33323e4577007366a3cea398f2656d26cfa5ca1e22e1ef8dde61e54aee285bcb0551fcc8566ed0615dfcb6b2fd28f54c0ce2b7315a8c68b9d1b5ccd8103fdc181013ebc3eed10258a0ca1baf5870d26afb52a1ee020411399c876f2c22e1d5925396c5165ec56b087f1b0fb5e1bea34f6dac5e6b1b92710e9f29975a6e49534cc0f703073772e271f22bc7050277dd0ac25d243bcf6b0ce6f1fe57f6c2819af54f008236acf898a7acbc693aee5c48a15b544ac24e84bf4348a1fa1e4a6f36ddd607f6b24d071693d9577a9780d3b3964e24769ea592a5b4387832a7e9cd77d02a130ce8ea6d152f15a6d5bc37f37d55aa3e27ff0a15fa70bd34a79a77197f1065a437886b2a1b0ccbc51c1637893de345585c7e10916f2165a938c0d49e4f7e7d88b8ebf29fac0ab65f41732f0f378ab1e2987c6a6bdaed505221d5db5dde18e4b55fc12ad4534b6dba96eb0979da6ed67e958c7e69258276c15bf8c2758a4afe870741694c51455f14e2ec049e796448edab64eddd47633db2a68f1bf8777bf57c8d62ee3fd16d9da35d986153c8d232abc002f32b51e30e029311fe2fdbf8e90ef8077ee893a813a4bbad39c1fe301be2908d4c9f86d0b813a8dc077147c14bfabc29bf01623f07d83002d988ff3fe4f38b79c8a7aeb0ea883b75ac0d7a9f803def98702bc55c6ffb180b76ae0ffabe0d3f8631515cc60e03f35c049bd9ff3febf8816dfbee3e9f07e0b3c79f72bdefdd702de2fe36f2cf07e0dfe7905cfe06f555c848b19fc0b063c6d572ff1febf8f9ecd960d4fc76eb460936e2ff3be7f12d88d32be6ac16ed4b0fface06bf81715cf43f68a8d7f33b06999fa3befff8f68ddad9b9d0ede6001a7ac19e79dff29c01b649cb0803730700915092449c54a5c4be092cb005fa74aa95a7f898e4b8b1de0b6cd4d47afb7a057a85206efad0af47a599a6b41afd7d03d8a344fca54b116eb18fa7ca7c4fca559e0b0a5fd906f6facb76a73732957a5051c78213b9ef856c4682e4b8b29950493d8aff1cf4a798a942be59b1b00052ee0810b9d6688ed49d0cc1634ed1ba2c9b0529556f04045ec358f18d8373969a5b6267272f6208c578922154ba52abe1ff732c956990c49f3f379601fbd084cb2430a924bec5a4ebe55ae57a54a1e742d4b03532fe79627d161aac0a1a9332ce3bf4191d64b34a9c3d8c7f89b50e56b54a99a436d31d522fc6dbcb0c65c512937eb78a1f90e5951a54a0dbc900e4d5eebd2bf271c3ab0493bb9ce91fc0ab8243a36cda963bd02bd913d81ee41f6c258474a51b1b66d36d336c2b68ab4a5f49ae6a2bdc0050ab82115506aa26f12c8f43dcdf29dddf02990a13dab540e504c27273a37518b66fa5646e5127d1664cd1b856c2fe48c426ee9082c292d3b0d85a529a76119ab28ba471cb9ce8395a2630fa4681ddf233a1653472c6d1b8655f743e11db0d80baba924452f7900c8a5e330d70b55ac61d309f6b89e810dc3a6262f6ca1c7320dea6e0624b5d0df0aa49caf8c83224335416d831a017d098d9a41b767d56ad0752c8cc0119fcb86a1d19376f90d9ba32a5cfba82a1326aebcea86cda56da2d0bdefe2f7d2138d3697c52cba531baec46e3d04e66d02f32681d93429663cc898d5eef8d5a946b5c9579e846f0bece27cb184b282de3a313f2b5de3fbee49f95eb3ad6052c2d75ced491b8aae774f519f3a45bd3c457dda14f59ea9003c16846d866a9e3443b602264bd14921db85d02a6cbe9d44632febd70a9b775b64d352584738e0be0df2bcb087ea1f82b6b67b61ef08ecd7bc18854b1ef142279f4707ab63f7cecbed72f4efb1f767f321cff096cf0719a42de3b095dd11f44258307e8c4d76fabc4b30eee3c091c4581fb2a35e6ecb12d1a9dd65c846a2ba6eb547b8c21ee1435347708c2a0da4b7a0f62d36bbe1085c2586f58218d663e734ac8f243d2cb763581fb547f8d8d4116e86395ef804b5739d00c50bd7b2d5cf0b9fa40fc78033c0c5075cdec0acbc0e3e25c67c9718f38d098d39d531e61b921e73aa63cc37d9237c46a4f0a7e31876b3b1289f12e48fbd43e4e5f8e46f11e4e370ff9cb1b827c73dcdc1fdd6a4b9a739b8df1693fbed71b8dfa12ff470b7e07e5342dc3de90ef25f499abcc79936ff1593fd49ade8a49d7d1d0d80d89ea254e7ecef15ec3f7b4ecadf9b3c7967da9c8e31cf49fa5178482b3d15a53ee3ff75f886e07f9fe07ff3b9a93f96fc009cb9f3ed98033839ca57cea2bb621af0383c21ce09b93400b6e1fd459c139ed40730023fc4a65827868ae3b0d50b3f8a719ed08e0d9ecce350e085a7b5faa8e3d509b82ab161663a86f95336cc7463983f63215c23f04c75de28fc3a8a67590a15ffce889d6784d60f9ae9b683660ea48c43c84dda4cc0469064f6a7413befbe002f0aa10649403a70e3d2ac97a649a8acf8429d4a4ca8ac5842bd6408f57bab50af34a56cf1c2ab54949f771b347be1cf4c8cfc73dad8fe4a1fc3f0c6d1143c31714a97f5259bacb5906ac89a052e4dd6b348d36502b658be6a1f13948766518af6f1067b4b61973ec282c5ac0dc57d396b7c9a2c981fdf82c3895930df61c104b360dc6e819b5b802e9b058bbce8e616b07d7618d33539cfe8728edbe4cc0597534e4426e71b5008c8eea7844e8b844e67a74d276f7c9d8612d3c96bd709e7c6d169be4da7855ef41a3a0de3424da6e71397c9c3652a209916511acd944cd9d32253b643a6fc1832c942a66593ca74fb3016252b538129d379b872c6665dceb4ccba1c874ca53164f2a4099d7c93ea7472182b12d569bed06995a95325ae153ae5099d5e99369d16c4d7e98ac4745ae0d0697d9c74da6c9329d78bd5463ad18968186b34a59e4b3ca33672a5969152b5582794ca174abd3a6d4a2d8cafd48712536aa143a9867819b57352a9d8d96b185b12954a4faa1d8654ec276d42aa5bb854d8336d522d8d2fd59b8949b5d421d57bec52257c6d82bb6d1df15fa6b83671f46eb3f76e679726741e6c710e7df564e7c187a0ba6df508beaf69329fdcc2a70de3504d8794cde27458cd9ab09b6ee1d36e7e8cc64a7e8cc67d169f2671a9269e4bcb8ec3522fee8fed12bb3d1d4bcca7650e9f2eb11fa327f7c953e8903a64eb8907a9c253485a373b07b02a85959b627b0a4db5b1a76dd508f636c53e86cf63172321127be3386c95b187140e639f50f8b498091f9fb699b03cee4cc0ecc4145eee507820d199e072087c993d970f4d8d9de024f9a03df015c94f123cc226c955894c928bcc498247b44972357e5858f82459984a9f576a168ee2c7368fe2bf555badc44f62142d61e5de7856964f6ab57bb277d254cba2f77c625613caea737a7bc54fd92db85e3fe9ae7365bb46f1332d5efc2c7bab5ae7e63b4ab63b9bb26309ffd798d5d9eed261fccf316878008fa7c051376d2bcf78f18b5475024ac84abc6314bf3a066d5efc1a955de0e690a7ec79c88c5b2d8c43cca4dd78271e1506ae05f96db81e912c6c5d38417ea6927d88321e635bd2ca097af3751b25407f1f7d138a28ca5d78f7ac3b1be3257a469d75bc6ee37d719d1d4dc0d907c7e06c52ce7e631a9c3d1de5ec69abb30fe323b3ee6c8c77f31975d6f1168fdf8aebecf71270f6b131c4a49c7d721a9c7d34cad947adcefe373e35ebcec6b84d9851679df70e3f8aebec4f1270f66763e849cad967a6c1d9a7a39c7ddaeaecb3f8cb597736c605c88c3aebbc2a792eaeb3bf4bc0d917c7b0202967ff300dce9e8972f68cd5d93fe2d9597736c69dcd8c3aebbcdd7925aeb37f4dc0d9d7c7705552cebe310dcebe16e5ec6b5667dfc4b766ddd918b74c33eaacf33eeaed78ce4a29533b2bb9c7706332ce4a69ff7f6725703a4b25a6b352baa4ccbab3316ec566d459c7fd993427aeb3590938eb1dc31deff43e2bcd8b72769ed5d96c2967d69d8d718937a3ce3aaefba445719d5d32b5b3b0690caa939ab34ba7c1d9dc286773adce2e9396cfbab3cbde61671d1784d279719d2d4b60ceae1ec39ea49c5d330dce1647395b6c75b65caa987567635c37cea8b38e8b49a92aaeb31724e0ece6313c9294b35ba7c1d9f551ceae379d95d8fff92d7e8a138214eda738ad49fd20d926512de33bcfe0abfd764ffff533a7e902e9fc8504fb9401bb57c0360ad884ffe943da3e251a45de4263bef61cc01c3fb09376240686ec87e8026cbef82dac5c5a963722ede43f0187ff03504b0708792fca614011000067430000504b0304140008080800dd86434f0000000000000000000000002f001100652f752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c61737355540d00072260965d2260965d2260965d3bf56fd73e06060633062e4606cd54fd52fdfca274fdc4ccfc3cfdc4b25cfdd2e2d4a29ccc24fdc4a44c7d47274fd78ae4d48212a0243b032323835caa7eb17e566259a27e4e625eba7e50695e49666e2a921a664606369bccbccc123b4606510d1f8452ffa4acd4e4126bcd301e065606362e06160676460616e7fc945406450626201704188110280b2439813c21a038139066d3d2decec0b111ac820100504b070842d95bd89f000000bd000000504b01021400140008080800dd86434fc01f64db650000007900000014000d0000000000000000000000000000004d4554412d494e462f4d414e49464553542e4d4655540500072260965dfeca0000504b01021400140008080800dd86434f3ee22bfb67010000090200002d00090000000000000000000000bc000000752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c61737355540500072260965d504b01021400140008080800dd86434feb568b3b50010000dc04000007000900000000000000000000008f020000432e636c61737355540500072260965d504b01021400140008080800dd86434f6af8b7e2c6000000fb0000005d0009000000000000000000000025040000752f6f72672f61696f6e2f61766d2f636f72652f6d69736376697369746f72732f696e7465726661636556697369746f722f696e74657266616365732f4649454c4453496e746572666163654661696c244649454c44532e636c61737355540500072260965d504b01021400140008080800dd86434fe299a8f8a00000001a010000560009000000000000000000000087050000752f6f72672f61696f6e2f61766d2f636f72652f6d69736376697369746f72732f696e7465726661636556697369746f722f696e74657266616365732f4649454c4453496e746572666163654661696c2e636c61737355540500072260965d504b01021400140008080800dd86434fdff0b6f8580c0000c02900002b00090000000000000000000000bc060000752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f414249456e636f6465722e636c61737355540500072260965d504b01021400140008080800dd86434f489d1d032d0300001806000057000900000000000000000000007e130000752f6f72672f61696f6e2f61766d2f636f72652f6d69736376697369746f72732f696e7465726661636556697369746f722f4669656c6473436c617373446566696e6564496e746572666163654661696c2e636c61737355540500072260965d504b01021400140008080800dd86434f792fca6140110000674300002b0009000000000000000000000041170000752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f4142494465636f6465722e636c61737355540500072260965d504b01021400140008080800dd86434f42d95bd89f000000bd0000002f00090000000000000000000000eb280000652f752f6f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c61737355540500072260965d504b05060000000009000900ca030000f82900000000";
        String objectGraph = "0000003f0300000000030000000103000000020300000003030000000403000000050300000006030000000703000000080300000009030000000a030000000b030000000c030000000d030000000e030000000f0300000010030000001103000000120300000013030000001403000000150300000016030000001703000000180300000019030000001a030000001b030000001c030000001d030000001e030000001f0300000020030000002103000000220300000023030000002403000000250300000026030000002703000000280300000029030000002a030000002b030000002c030000002d030000002e030000002f0300000030030000003103000000320300000033030000003403000000350300000036030000003703000000380300000039030000003a030000003b030000003c030000003d030000003a000000ff00000008000000ff0000000000000001106a6176612e6c616e672e537472696e6700000001000000204164647265737320776173206f6620756e6578706563746564206c656e677468106a6176612e6c616e672e537472696e6700000002000000204172726179206c656e677468206d7573742066697420696e2032206279746573106a6176612e6c616e672e537472696e670000000b00000023436f756c64206e6f74206465636f6465206120426967496e7465676572206172726179106a6176612e6c616e672e537472696e670000000c0000001f436f756c64206e6f74206465636f6465206120737472696e67206172726179106a6176612e6c616e672e537472696e670000000d00000021436f756c64206e6f74206465636f646520616e2061646472657373206172726179106a6176612e6c616e672e537472696e670000000e0000004544617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420426967496e7465676572206c656e6774682e106a6176612e6c616e672e537472696e670000000f0000004044617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f2072656164206120426967496e74656765722e106a6176612e6c616e672e537472696e67000000100000003d44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f2072656164206120626f6f6c65616e2e106a6176612e6c616e672e537472696e67000000110000003a44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f2072656164206120627974652e106a6176612e6c616e672e537472696e67000000120000003c44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f2072656164206120646f75626c652e106a6176612e6c616e672e537472696e67000000130000003b44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f2072656164206120666c6f61742e106a6176612e6c616e672e537472696e67000000140000003a44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f20726561642061206c6f6e672e106a6176612e6c616e672e537472696e67000000030000002e426967496e74656765722076616c7565206578636565647320746865206c696d6974206f66203332206279746573106a6176612e6c616e672e537472696e67000000150000003b44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420612073686f72742e106a6176612e6c616e672e537472696e67000000160000003c44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f2072656164206120737472696e672e106a6176612e6c616e672e537472696e67000000170000003e44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420616e20616464726573732e106a6176612e6c616e672e537472696e67000000180000003c44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420616e2061727261792e106a6176612e6c616e672e537472696e67000000190000003e44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420616e20696e74656765722e106a6176612e6c616e672e537472696e670000001a0000004344617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420616e206f626a6563742061727261792e106a6176612e6c616e672e537472696e670000001b0000003d44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420616e206f626a6563742e106a6176612e6c616e672e537472696e670000001c0000003e44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f207265616420746869732061727261792e106a6176612e6c616e672e537472696e670000001d0000003f44617461206669656c6420646f6573206e6f74206861766520656e6f756768206279746573206c65667420746f2072656164207468697320737472696e672e106a6176612e6c616e672e537472696e670000001e000000354e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120324420626f6f6c65616e2061727261792e106a6176612e6c616e672e537472696e670000000400000023436f756c64206e6f74206465636f6465206120324420626f6f6c65616e206172726179106a6176612e6c616e672e537472696e670000001f000000324e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120324420627974652061727261792e106a6176612e6c616e672e537472696e6700000020000000374e65787420656c656d656e7420696e2064617461206669656c64206973206e6f742061203244206368617261637465722061727261792e106a6176612e6c616e672e537472696e6700000021000000344e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120324420646f75626c652061727261792e106a6176612e6c616e672e537472696e6700000022000000334e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120324420666c6f61742061727261792e106a6176612e6c616e672e537472696e6700000023000000354e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120324420696e74656765722061727261792e106a6176612e6c616e672e537472696e6700000024000000324e65787420656c656d656e7420696e2064617461206669656c64206973206e6f742061203244206c6f6e672061727261792e106a6176612e6c616e672e537472696e6700000025000000334e65787420656c656d656e7420696e2064617461206669656c64206973206e6f7420612032442073686f72742061727261792e106a6176612e6c616e672e537472696e6700000026000000354e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120426967496e74656765722061727261792e106a6176612e6c616e672e537472696e67000000270000002f4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120426967496e74656765722e106a6176612e6c616e672e537472696e67000000280000002c4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120626f6f6c65616e2e106a6176612e6c616e672e537472696e670000000500000020436f756c64206e6f74206465636f646520612032442062797465206172726179106a6176612e6c616e672e537472696e67000000290000002f4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120627974652061727261792e106a6176612e6c616e672e537472696e670000002a000000294e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120627974652e106a6176612e6c616e672e537472696e670000002b000000344e65787420656c656d656e7420696e2064617461206669656c64206973206e6f742061206368617261637465722061727261792e106a6176612e6c616e672e537472696e670000002c000000314e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120646f75626c652061727261792e106a6176612e6c616e672e537472696e670000002d0000002b4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120646f75626c652e106a6176612e6c616e672e537472696e670000002e000000304e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120666c6f61742061727261792e106a6176612e6c616e672e537472696e670000002f0000002a4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120666c6f61742e106a6176612e6c616e672e537472696e67000000300000002f4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f742061206c6f6e672061727261792e106a6176612e6c616e672e537472696e6700000031000000294e65787420656c656d656e7420696e2064617461206669656c64206973206e6f742061206c6f6e672e106a6176612e6c616e672e537472696e6700000032000000304e65787420656c656d656e7420696e2064617461206669656c64206973206e6f7420612073686f72742061727261792e106a6176612e6c616e672e537472696e670000000600000025436f756c64206e6f74206465636f6465206120324420636861726163746572206172726179106a6176612e6c616e672e537472696e67000000330000002a4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f7420612073686f72742e106a6176612e6c616e672e537472696e6700000034000000314e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120737472696e672061727261792e106a6176612e6c616e672e537472696e67000000350000002b4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f74206120737472696e672e106a6176612e6c616e672e537472696e6700000036000000334e65787420656c656d656e7420696e2064617461206669656c64206973206e6f7420616e20616464726573732061727261792e106a6176612e6c616e672e537472696e67000000370000002d4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f7420616e20616464726573732e106a6176612e6c616e672e537472696e6700000038000000334e65787420656c656d656e7420696e2064617461206669656c64206973206e6f7420616e20696e74656765722061727261792e106a6176612e6c616e672e537472696e67000000390000002d4e65787420656c656d656e7420696e2064617461206669656c64206973206e6f7420616e20696e74656765722e106a6176612e6c616e672e537472696e670000003a00000030547269656420746f206465636f64652066726f6d2061206e756c6c206f7220656d7074792064617461206669656c642e106a6176612e6c616e672e537472696e670000003b00000013676574496e6e6572436c617373537472696e67106a6176612e6c616e672e537472696e670000003c00000012676574496e74657266616365537472696e67106a6176612e6c616e672e537472696e670000000700000021436f756c64206e6f74206465636f6465206120324420666c6f6174206172726179106a6176612e6c616e672e537472696e670000003d00000005696e6e6572106a6176612e6c616e672e537472696e670000003e000000056f75746572106a6176612e6c616e672e537472696e670000000800000023436f756c64206e6f74206465636f6465206120324420696e7465676572206172726179106a6176612e6c616e672e537472696e670000000900000020436f756c64206e6f74206465636f64652061203244206c6f6e67206172726179106a6176612e6c616e672e537472696e670000000a00000021436f756c64206e6f74206465636f646520612032442073686f7274206172726179";

        kernel.setTransformedCode(dappAddress, Helpers.hexStringToBytes(transformedCode));
        kernel.putObjectGraph(dappAddress, Helpers.hexStringToBytes(objectGraph));

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "getInterfaceString",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals("outer", new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneString());

        kernel.generateBlock();
        // call to inner FIELDS class will fail
        result = callDapp(kernel, deployer, dappAddress, "getInnerClassString",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isFailed());

        //re-transform the code
        kernel.setTransformedCode(dappAddress, null);
        kernel.generateBlock();

        // all calls to contract will fail
        result = callDapp(kernel, deployer, dappAddress, "getInterfaceString",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isFailed());

        kernel.generateBlock();
        result = callDapp(kernel, deployer, dappAddress, "getInnerClassString",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isFailed());
    }

    @Test
    public void FIELDSNotDefinedInInterfaceSuccess() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(FieldsNotDefinedSuccess.class, NoFIELDSInterface.class, SampleObj.class, ABIEncoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        String objectGraphHex = "000000090300000000030000000103000000020300000003030000000400000001000000040000000200000003000000ff0000000000000001106a6176612e6c616e672e537472696e6700000001000000204164647265737320776173206f6620756e6578706563746564206c656e677468106a6176612e6c616e672e537472696e6700000002000000204172726179206c656e677468206d7573742066697420696e2032206279746573106a6176612e6c616e672e537472696e67000000030000002e426967496e74656765722076616c7565206578636565647320746865206c696d6974206f66203332206279746573396f72672e61696f6e2e61766d2e636f72652e6d69736376697369746f72732e696e7465726661636556697369746f722e53616d706c654f626a00000004000003e8106a6176612e6c616e672e537472696e67000000080000001553616d706c654f626a7b636f756e743d313030307d";

        kernel.putObjectGraph(dappAddress, Helpers.hexStringToBytes(objectGraphHex));
        kernel.generateBlock();

        //re-transform the code
        kernel.setTransformedCode(dappAddress, null);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals(31, new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneInteger());
    }

    @Test
    public void FIELDSInInnerInterface() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(ClassWithNestedInterfaces.class, LevelOneInterface.class, ABIEncoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        String objectGraphHex = "00000004030000000003000000010300000002000000ff0000000000000001106a6176612e6c616e672e537472696e6700000001000000204164647265737320776173206f6620756e6578706563746564206c656e677468106a6176612e6c616e672e537472696e6700000002000000204172726179206c656e677468206d7573742066697420696e2032206279746573106a6176612e6c616e672e537472696e67000000030000002e426967496e74656765722076616c7565206578636565647320746865206c696d6974206f66203332206279746573";
        kernel.generateBlock();

        kernel.putObjectGraph(dappAddress, Helpers.hexStringToBytes(objectGraphHex));

        //re-transform the code
        kernel.setTransformedCode(dappAddress, null);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isFailed());
    }

    @Test
    public void FIELDSDefinedInInterfaceSuccess() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(AcceptFieldsNewAVM.class, FIELDSInterfaceSuccess.class, ABIEncoder.class, ABIDecoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals(115, new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneInteger());
    }

    @Test
    public void FIELDSAsInnerInterfaceName() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(ClassWithFIELDSAsInterfaceName.class, InnerFIELDSInterface.class, ABIEncoder.class, ABIException.class, InnerFIELDSImplementation.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        byte[] objectGraph = Helpers.hexStringToBytes("0000000503000000000300000001030000000200000064000000cc0300000003000000ff0000000000000001106a6176612e6c616e672e537472696e6700000001000000204164647265737320776173206f6620756e6578706563746564206c656e677468106a6176612e6c616e672e537472696e6700000002000000204172726179206c656e677468206d7573742066697420696e2032206279746573106a6176612e6c616e672e537472696e67000000030000002e426967496e74656765722076616c7565206578636565647320746865206c696d6974206f66203332206279746573106a6176612e6c616e672e4f626a65637400000004");
        kernel.putObjectGraph(dappAddress, objectGraph);
        //re-transform the code
        kernel.setTransformedCode(dappAddress, null);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        // number of processed classes will be different
        Assert.assertTrue(result.transactionStatus.isFailed());
    }

    @Test
    public void FIELDSAsInterfaceName() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(ClassWithFieldsInterface.class, ABIEncoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        byte[] objectGraph = Helpers.hexStringToBytes("00000007030000000003000000010300000002030000000303000000030300000004030000000500000006000000ff0000000000000001106a6176612e6c616e672e537472696e6700000001000000204164647265737320776173206f6620756e6578706563746564206c656e677468106a6176612e6c616e672e537472696e6700000002000000204172726179206c656e677468206d7573742066697420696e2032206279746573106a6176612e6c616e672e537472696e67000000030000002e426967496e74656765722076616c7565206578636565647320746865206c696d6974206f66203332206279746573106a6176612e6c616e672e537472696e670000000400000003616263106a6176612e6c616e672e4f626a65637400000005106a6176612e6c616e672e4f626a65637400000006");
        kernel.putObjectGraph(dappAddress, objectGraph);
        //re-transform the code
        kernel.setTransformedCode(dappAddress, null);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        // number of processed classes will be different
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals(14, new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneInteger());
    }

    @Test
    public void FIELDSAsInterfaceNameAVM2() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(ClassWithFieldsInterface.class, ABIEncoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        // number of processed classes will be different
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals(14, new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneInteger());
    }

    @Test
    public void FIELDSAsInnerInterfaceNameAVM2() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(ClassWithFIELDSAsInterfaceName.class, InnerFIELDSInterface.class, ABIEncoder.class, ABIException.class, InnerFIELDSImplementation.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals(309, new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneInteger());
    }

    @Test
    public void testInnerInterfaceAllFIELDS() {
        Map<String, byte[]> classes = new HashMap<>();

        classes.put("NestedInterfaces", getInnerFILEDSInterfaceBytes());
        classes.put("NestedInterfaces$FIELDS", getNestedInterfaceCalledFIELDSLevelOne());
        classes.put("NestedInterfaces$FIELDS$FIELDS", getNestedInterfaceCalledFIELDSLevelTwo());

        byte[] jar = JarBuilder.buildJarForExplicitClassNamesAndBytecode("NestedMain", getFIELDMainClassBytes(), classes);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertArrayEquals(new byte[405], result.copyOfTransactionOutput().orElseThrow());
    }

    @Test
    public void testInterfaceWithNoDeclaredFields() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(ImplementationNoFields.class, InterfaceNoFields.class, ABIEncoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        // values below are retrieved from the old version of the AVM (with InterfaceFieldMappingVisitor) after deployment
        byte[] objectGraph = Helpers.hexStringToBytes("00000004030000000003000000010300000002000000ff0000000000000001106a6176612e6c616e672e537472696e6700000001000000204164647265737320776173206f6620756e6578706563746564206c656e677468106a6176612e6c616e672e537472696e6700000002000000204172726179206c656e677468206d7573742066697420696e2032206279746573106a6176612e6c616e672e537472696e67000000030000002e426967496e74656765722076616c7565206578636565647320746865206c696d6974206f66203332206279746573");
        kernel.putObjectGraph(dappAddress, objectGraph);

        //re-transform the code
        kernel.setTransformedCode(dappAddress, null);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals(22022, new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneInteger());
    }

    @Test
    public void testInterfaceWithNoDeclaredFieldsAVM2() {
        byte[] jar = JarBuilder.buildJarForMainAndClasses(ImplementationNoFields.class, InterfaceNoFields.class, ABIEncoder.class, ABIException.class);
        byte[] txData = new CodeAndArguments(jar, new byte[0]).encodeToBytes();
        AionAddress dappAddress = deploy(deployer, kernel, txData);

        TransactionResult result = callDapp(kernel, deployer, dappAddress, "",
                ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1);
        Assert.assertTrue(result.transactionStatus.isSuccess());
        Assert.assertEquals(22022, new ABIDecoder(result.copyOfTransactionOutput().orElseThrow()).decodeOneInteger());
    }

    private static TransactionResult callDapp(TestingState kernel, AionAddress sender, AionAddress dappAddress,
                                              String methodName, ExecutionType executionType, long commonMainchainBlockNumber, Object... args) {
        ABIStreamingEncoder encoder = new ABIStreamingEncoder().encodeOneString(methodName);
        for (Object arg : args) {
            encoder.encodeOneByteArray((byte[]) arg);
        }
        byte[] data = encoder.toBytes();
        Transaction tx = AvmTransactionUtil.call(sender, dappAddress, kernel.getNonce(sender), BigInteger.ZERO, data, 2_000_00, 1);
        return avm.run(kernel, new Transaction[]{tx}, executionType, commonMainchainBlockNumber)[0].getResult();
    }

    private static AionAddress deploy(AionAddress deployer, TestingState kernel, byte[] txData) {
        Transaction tx1 = AvmTransactionUtil.create(deployer, kernel.getNonce(deployer), BigInteger.ZERO, txData, 5_000_000, 1);
        TransactionResult result = avm.run(kernel, new Transaction[]{tx1}, ExecutionType.ASSUME_MAINCHAIN, kernel.getBlockNumber() - 1)[0].getResult();
        assertTrue(result.transactionStatus.isSuccess());
        return new AionAddress(result.copyOfTransactionOutput().orElseThrow());
    }
}

